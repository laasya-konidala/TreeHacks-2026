<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      overflow: hidden;
    }

    .panel {
      position: absolute;
      top: 16px;
      right: 16px;
      bottom: 80px;
      width: 340px;
      background: rgba(20, 20, 30, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      cursor: grab;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .agent-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .agent-icon.conceptual { background: rgba(139, 92, 246, 0.3); }
    .agent-icon.applied { background: rgba(59, 130, 246, 0.3); }
    .agent-icon.consolidation { background: rgba(16, 185, 129, 0.3); }
    .agent-icon.idle { background: rgba(255, 255, 255, 0.1); }

    .title {
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      font-weight: 600;
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.4);
      font-size: 11px;
    }

    /* ‚îÄ‚îÄ Toggle button ‚îÄ‚îÄ */
    .toggle-btn {
      width: 40px;
      height: 24px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      position: relative;
      transition: background 0.3s;
      background: rgba(255, 255, 255, 0.15);
    }

    .toggle-btn.active {
      background: rgba(16, 185, 129, 0.6);
    }

    .toggle-btn::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      transition: transform 0.3s;
    }

    .toggle-btn.active::after {
      transform: translateX(16px);
    }

    /* ‚îÄ‚îÄ Status bar ‚îÄ‚îÄ */
    .status-bar {
      padding: 8px 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      flex-shrink: 0;
      transition: background 0.3s;
    }

    .status-dot.ready { background: #fbbf24; }
    .status-dot.connecting { background: #f97316; animation: pulse 1s infinite; }
    .status-dot.active { background: #10b981; animation: pulse 2s infinite; }
    .status-dot.error { background: #ef4444; }
    .status-dot.disconnected { background: rgba(255, 255, 255, 0.3); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .status-text {
      color: rgba(255, 255, 255, 0.5);
      font-size: 11px;
      flex: 1;
    }

    .mic-indicator {
      font-size: 12px;
      opacity: 0.3;
      transition: opacity 0.3s;
    }

    .mic-indicator.listening {
      opacity: 1;
    }

    /* ‚îÄ‚îÄ Feed area (scrollable as content grows) ‚îÄ‚îÄ */
    .feed {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .feed::-webkit-scrollbar { width: 4px; }
    .feed::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 2px;
    }

    .feed-item {
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      animation: fadeIn 0.3s ease;
    }

    .feed-item .time {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.25);
      margin-bottom: 6px;
    }

    .feed-item .text {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .feed-item .speech-tag {
      font-size: 10px;
      color: rgba(139, 92, 246, 0.7);
      margin-bottom: 4px;
    }

    .feed-item.mode-CONCEPTUAL { border-left: 2px solid rgba(139, 92, 246, 0.5); }
    .feed-item.mode-APPLIED { border-left: 2px solid rgba(59, 130, 246, 0.5); }
    .feed-item.mode-CONSOLIDATION { border-left: 2px solid rgba(16, 185, 129, 0.5); }

    .feed-item.agent-response {
      border-left: 2px solid rgba(239, 68, 68, 0.7);
      background: rgba(239, 68, 68, 0.08);
    }
    .feed-item.agent-response .agent-badge {
      display: inline-block;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 4px;
      background: rgba(239, 68, 68, 0.15);
      color: rgba(239, 68, 68, 0.9);
      margin-left: 6px;
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ Agent trigger flash banner ‚îÄ‚îÄ */
    .agent-flash {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 12px 20px;
      background: linear-gradient(135deg, #ef4444, #f97316);
      color: white;
      font-weight: 700;
      font-size: 14px;
      text-align: center;
      z-index: 9999;
      animation: flashIn 0.3s ease, flashPulse 0.6s ease 0.3s 2;
      letter-spacing: 1px;
      text-transform: uppercase;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.5);
    }
    .agent-flash .flash-detail {
      font-size: 11px;
      font-weight: 400;
      opacity: 0.9;
      margin-top: 2px;
      text-transform: none;
      letter-spacing: 0;
    }
    @keyframes flashIn {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes flashPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    @keyframes flashOut {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(-100%); opacity: 0; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.25);
      font-size: 13px;
      text-align: center;
      padding: 40px;
      line-height: 1.6;
    }

    .empty-state .icon { font-size: 32px; margin-bottom: 12px; }

    /* ‚îÄ‚îÄ Avatar dropdown ‚îÄ‚îÄ */
    .avatar-row {
      -webkit-app-region: no-drag;
      padding: 10px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .avatar-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
      font-weight: 500;
    }
    .avatar-select {
      flex: 1;
      max-width: 140px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.9);
      font-size: 13px;
      cursor: pointer;
    }
    .avatar-select:focus {
      outline: none;
      border-color: rgba(16, 185, 129, 0.5);
    }

    /* ‚îÄ‚îÄ Slide to call (footer) ‚îÄ‚îÄ */
    .call-footer {
      padding: 16px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      flex-shrink: 0;
    }

    .slide-to-call {
      height: 48px;
      border-radius: 24px;
      background: rgba(255, 255, 255, 0.08);
      position: relative;
      cursor: default;
      display: flex;
      align-items: center;
      overflow: hidden;
      user-select: none;
    }

    .slide-to-call-track {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 0;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 24px;
      transition: width 0.15s ease-out;
    }

    .slide-to-call-thumb {
      width: 44px;
      height: 44px;
      margin: 2px;
      border-radius: 50%;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      left: 2px;
      top: 2px;
      z-index: 2;
      cursor: grab;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
      transition: transform 0.1s ease;
    }

    .slide-to-call-thumb:active {
      cursor: grabbing;
      transform: scale(0.96);
    }

    .slide-to-call-thumb svg {
      width: 22px;
      height: 22px;
      color: #1a1a1a;
      pointer-events: none;
    }

    .slide-to-call-label {
      position: absolute;
      left: 0;
      right: 0;
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
      font-size: 12px;
      pointer-events: none;
      z-index: 1;
    }

    /* ‚îÄ‚îÄ In-call UI (voice speaking bars) ‚îÄ‚îÄ */
    .in-call-ui {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 16px 20px;
    }

    .in-call-ui.visible {
      display: flex;
    }

    .voice-bars {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 6px;
      height: 32px;
    }

    .voice-bar {
      width: 4px;
      min-height: 8px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 2px;
      animation: voicePulse 0.6s ease-in-out infinite alternate;
    }

    .voice-bar:nth-child(1) { animation-delay: 0s; }
    .voice-bar:nth-child(2) { animation-delay: 0.1s; }
    .voice-bar:nth-child(3) { animation-delay: 0.2s; }
    .voice-bar:nth-child(4) { animation-delay: 0.15s; }
    .voice-bar:nth-child(5) { animation-delay: 0.05s; }
    .voice-bar:nth-child(6) { animation-delay: 0.25s; }
    .voice-bar:nth-child(7) { animation-delay: 0.1s; }

    @keyframes voicePulse {
      from { height: 8px; opacity: 0.6; }
      to { height: 28px; opacity: 1; }
    }

    .in-call-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
    }

    .end-call-btn {
      width: 56px;
      height: 56px;
      border: none;
      border-radius: 50%;
      background: #ef4444;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      box-shadow: 0 2px 12px rgba(239, 68, 68, 0.4);
    }

    .end-call-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }

    .end-call-btn:active {
      transform: scale(0.96);
    }

    .end-call-btn svg {
      width: 26px;
      height: 26px;
    }

    /* ‚îÄ‚îÄ Visualization cards (lighter background, click to enlarge) ‚îÄ‚îÄ */
    .viz-feed-card {
      margin-top: 4px;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.12);
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
    }
    .viz-feed-card:hover {
      background: rgba(255, 255, 255, 0.16);
      border-color: rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    }
    .viz-feed-card .viz-title { font-size: 14px; color: rgba(255, 255, 255, 0.95); margin-bottom: 8px; }
    .viz-feed-card .viz-canvas { min-height: 100px; background: rgba(0, 0, 0, 0.15); border-radius: 8px; padding: 10px; margin-bottom: 8px; }
    .viz-feed-card .viz-narration { font-size: 12px; color: rgba(255, 255, 255, 0.7); line-height: 1.4; }
    .viz-feed-card .katex { font-size: 1.05em; }
    .viz-feed-card .mermaid { background: transparent; }

    /* ‚îÄ‚îÄ Test viz buttons ‚îÄ‚îÄ */
    .test-viz-row {
      -webkit-app-region: no-drag;
      padding: 8px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .test-viz-row label { font-size: 11px; color: rgba(255, 255, 255, 0.5); margin-right: 4px; }
    .test-viz-btn {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.9);
      cursor: pointer;
    }
    .test-viz-btn:hover { background: rgba(255, 255, 255, 0.15); }

    /* ‚îÄ‚îÄ Enlarged viz modal ‚îÄ‚îÄ */
    .viz-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .viz-modal-backdrop.is-open {
      display: flex;
    }
    .viz-modal-box {
      background: rgba(32, 32, 45, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 16px;
      max-width: 90vw;
      max-height: 90vh;
      width: 560px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.5);
    }
    .viz-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    .viz-modal-title { font-size: 15px; font-weight: 600; color: rgba(255, 255, 255, 0.95); }
    .viz-modal-close {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.85);
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .viz-modal-close:hover { background: rgba(255, 255, 255, 0.2); }
    .viz-modal-body {
      flex: 1;
      min-height: 0;
      overflow: auto;
      padding: 18px;
    }
    .viz-modal-body .viz-canvas {
      min-height: 280px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 16px;
    }
    .viz-modal-body .viz-canvas .katex { font-size: 1.3em; }
    .viz-modal-body .viz-narration {
      margin-top: 10px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.5;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
  <div class="panel">
    <div class="avatar-row">
      <label for="avatarSelect" class="avatar-label">Avatar</label>
      <select id="avatarSelect" class="avatar-select" title="Choose avatar">
        <option value="plato">Plato</option>
        <option value="einstein">Einstein</option>
      </select>
    </div>
    <div class="header">
      <div class="header-left">
        <div class="agent-icon idle" id="agentIcon">üëÅÔ∏è</div>
        <div>
          <div class="title" id="agentName">Learning Agent</div>
          <div class="subtitle" id="agentMode">Idle</div>
        </div>
      </div>
      <button class="toggle-btn" id="toggleBtn" title="Start/stop session"></button>
    </div>

    <div class="status-bar">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-text" id="statusText">Initializing...</span>
      <span class="mic-indicator" id="micIndicator">üé§</span>
    </div>

    <div class="test-viz-row">
      <label>Visualize:</label>
      <button type="button" class="test-viz-btn" data-tier="static">LaTeX</button>
      <button type="button" class="test-viz-btn" data-tier="static-mermaid">Mermaid</button>
      <button type="button" class="test-viz-btn" data-tier="d3">D3</button>
      <button type="button" class="test-viz-btn" data-tier="interactive">Plotly</button>
      <button type="button" class="test-viz-btn" data-tier="manim">Manim</button>
    </div>

    <div class="feed" id="feed">
      <div class="empty-state" id="emptyState">
        <div class="icon">üëÅÔ∏è</div>
        <div>Toggle the switch to start.<br>I'll watch your screen and listen<br>to understand what you're learning.</div>
      </div>
    </div>

    <div class="call-footer">
      <div class="in-call-ui" id="inCallUI">
        <div class="voice-bars" aria-hidden="true">
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
          <div class="voice-bar"></div>
        </div>
        <span class="in-call-label">Speaking‚Ä¶</span>
        <button class="end-call-btn" id="endCallBtn" title="End call">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
          </svg>
        </button>
      </div>
      <div class="slide-to-call" id="slideToCall">
        <div class="slide-to-call-track" id="slideTrack"></div>
        <div class="slide-to-call-thumb" id="slideThumb">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
          </svg>
        </div>
        <span class="slide-to-call-label">Slide to call agent</span>
      </div>
    </div>
  </div>

  <div class="viz-modal-backdrop" id="vizModal" aria-hidden="true">
    <div class="viz-modal-box" role="dialog" aria-label="Enlarged visualization">
      <div class="viz-modal-header">
        <span class="viz-modal-title" id="vizModalTitle">Visualization</span>
        <button type="button" class="viz-modal-close" id="vizModalClose" title="Close">√ó</button>
      </div>
      <div class="viz-modal-body">
        <div class="viz-canvas" id="vizModalCanvas"></div>
        <div class="viz-narration" id="vizModalNarration"></div>
      </div>
    </div>
  </div>

  <script>
    const BACKEND_ORIGIN = 'http://localhost:8080';
    const feed = document.getElementById('feed');
    const emptyState = document.getElementById('emptyState');
    const vizModal = document.getElementById('vizModal');
    const vizModalTitle = document.getElementById('vizModalTitle');
    const vizModalCanvas = document.getElementById('vizModalCanvas');
    const vizModalNarration = document.getElementById('vizModalNarration');
    const vizModalClose = document.getElementById('vizModalClose');
    const vizPayloadsByCardId = {};
    const toggleBtn = document.getElementById('toggleBtn');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const micIndicator = document.getElementById('micIndicator');
    const agentIcon = document.getElementById('agentIcon');
    const agentName = document.getElementById('agentName');
    const agentMode = document.getElementById('agentMode');
    const header = document.querySelector('.header');

    let isActive = false;

    // ‚îÄ‚îÄ Manual drag for header (moves cat + sidebar together) ‚îÄ‚îÄ
    let headerDragging = false;
    let headerStartX = 0;
    let headerStartY = 0;

    header.addEventListener('mousedown', (e) => {
      if (e.target.closest('.toggle-btn') || e.target.closest('.call-footer')) return;
      headerDragging = true;
      headerStartX = e.screenX;
      headerStartY = e.screenY;
    });

    document.addEventListener('mousemove', (e) => {
      if (!headerDragging) return;
      const dx = e.screenX - headerStartX;
      const dy = e.screenY - headerStartY;
      if (Math.abs(dx) > 3 || Math.abs(dy) > 3) {
        window.api.moveWindow(dx, dy);
        headerStartX = e.screenX;
        headerStartY = e.screenY;
      }
    });

    document.addEventListener('mouseup', () => {
      headerDragging = false;
    });

    // ‚îÄ‚îÄ Slide to call (design only, no functionality yet) ‚îÄ‚îÄ
    const slideToCall = document.getElementById('slideToCall');
    const slideThumb = document.getElementById('slideThumb');
    const slideTrack = document.getElementById('slideTrack');
    let slideDragging = false;
    let slideStartX = 0;
    let slideThumbStartX = 0;

    slideThumb.addEventListener('mousedown', (e) => {
      e.preventDefault();
      slideDragging = true;
      slideStartX = e.clientX;
      slideThumbStartX = slideThumb.offsetLeft;
    });

    document.addEventListener('mousemove', (e) => {
      if (!slideDragging) return;
      const trackWidth = slideToCall.offsetWidth - slideThumb.offsetWidth - 4;
      let newLeft = slideThumbStartX + (e.clientX - slideStartX);
      newLeft = Math.max(2, Math.min(trackWidth, newLeft));
      slideThumb.style.left = newLeft + 'px';
      slideTrack.style.width = newLeft + 'px';
    });

    const inCallUI = document.getElementById('inCallUI');
    const endCallBtn = document.getElementById('endCallBtn');

    document.addEventListener('mouseup', () => {
      if (slideDragging) {
        const trackWidth = slideToCall.offsetWidth - slideThumb.offsetWidth - 4;
        const threshold = trackWidth * 0.75;
        if (slideThumb.offsetLeft >= threshold) {
          slideThumb.style.left = trackWidth + 'px';
          slideTrack.style.width = trackWidth + 'px';
          slideToCall.style.display = 'none';
          inCallUI.classList.add('visible');
        } else {
          slideThumb.style.left = '2px';
          slideTrack.style.width = '0px';
        }
        slideDragging = false;
      }
    });

    endCallBtn.addEventListener('click', () => {
      inCallUI.classList.remove('visible');
      slideToCall.style.display = 'flex';
      slideThumb.style.left = '2px';
      slideTrack.style.width = '0px';
    });

    // ‚îÄ‚îÄ Speech Recognition (Web Speech API ‚Äî runs locally) ‚îÄ‚îÄ
    let recognition = null;

    function startSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.warn('[Speech] Web Speech API not available');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            const transcript = event.results[i][0].transcript.trim();
            if (transcript) {
              console.log('[Speech]', transcript);
              window.api.sendSpeechTranscript(transcript);
            }
          }
        }
      };

      recognition.onerror = (event) => {
        console.warn('[Speech] Error:', event.error);
        // Restart on non-fatal errors
        if (event.error === 'no-speech' || event.error === 'aborted') {
          if (isActive) {
            setTimeout(() => {
              try { recognition.start(); } catch (e) {}
            }, 500);
          }
        }
      };

      recognition.onend = () => {
        // Auto-restart if session is still active
        if (isActive) {
          try { recognition.start(); } catch (e) {}
        }
        micIndicator.classList.toggle('listening', isActive);
      };

      try {
        recognition.start();
        micIndicator.classList.add('listening');
        console.log('[Speech] Recognition started');
      } catch (e) {
        console.error('[Speech] Start error:', e);
      }
    }

    function stopSpeechRecognition() {
      if (recognition) {
        try { recognition.stop(); } catch (e) {}
        recognition = null;
      }
      micIndicator.classList.remove('listening');
    }

    // ‚îÄ‚îÄ Avatar dropdown ‚îÄ‚îÄ
    document.getElementById('avatarSelect').addEventListener('change', (e) => {
      window.api.setAvatar(e.target.value);
    });

    // ‚îÄ‚îÄ Test visualization payloads (tier format: static / static-mermaid / interactive / manim) ‚îÄ‚îÄ
    const TEST_VIZ = {
      static: {
        content_type: 'visualization',
        content: 'The gradient points uphill; gradient descent moves in the opposite direction.',
        metadata: {
          tier: 'static',
          visualization: {
            tier: 'static',
            format: 'latex',
            title: 'Understanding the gradient',
            content: '\\nabla f(x) = \\left( \\frac{\\partial f}{\\partial x_1}, \\frac{\\partial f}{\\partial x_2} \\right), \\quad \\text{gradient descent: } x_{n+1} = x_n - \\alpha \\nabla f(x_n)'
          }
        }
      },
      'static-mermaid': {
        content_type: 'visualization',
        content: 'Flow of gradient descent.',
        metadata: {
          tier: 'static',
          visualization: {
            tier: 'static',
            format: 'mermaid',
            title: 'Gradient descent flow',
            content: 'flowchart LR\nA[Start] --> B[Compute gradient]\nB --> C[Update x]\nC --> D{Converged?}\nD -->|No| B\nD -->|Yes| E[Stop]'
          }
        }
      },
      d3: {
        content_type: 'visualization',
        content: 'A simple D3 diagram runs in the card.',
        metadata: {
          tier: 'd3',
          visualization: {
            tier: 'd3',
            title: 'Sample D3 diagram',
            narration: 'Custom diagrams from the tool use D3 in a sandboxed iframe.',
            code: 'function draw(container) { var data = [1,2,3,4,5]; container.innerHTML = ""; var sel = d3.select(container).selectAll("div").data(data).enter().append("div").style("height", "20px").style("width", function(d) { return (d * 40) + "px"; }).style("background", "#3b82f6").style("margin", "2px 0").style("border-radius", "4px"); }'
          }
        }
      },
      interactive: {
        content_type: 'visualization',
        content: 'Drag to explore. The red line is the regression fit.',
        metadata: {
          tier: 'interactive',
          visualization: {
            tier: 'interactive',
            renderer: 'plotly',
            title: 'Linear Regression ‚Äî Fitting a Line',
            narration: 'Linear regression finds the line that minimizes the sum of squared residuals.',
            plotly_figure: {
              data: [
                { x: [0,0.2,0.4,0.6,0.8,1,1.2,1.4,1.6,1.8,2], y: [0.1,0.35,0.6,0.9,1.1,1.4,1.7,2,2.3,2.5,2.8], mode: 'markers', type: 'scatter', name: 'Data', marker: { size: 10, color: '#3b82f6' } },
                { x: [0,2], y: [0.05,2.75], mode: 'lines', type: 'scatter', name: 'Fit', line: { color: '#ef4444', width: 2 } }
              ],
              layout: { title: 'Linear Regression', xaxis: { title: 'x' }, yaxis: { title: 'y' }, margin: { t: 40, b: 40, l: 50, r: 20 }, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(255,255,255,0.05)', font: { color: '#e5e7eb', size: 12 } }
            }
          }
        }
      },
      manim: {
        content_type: 'visualization',
        content: 'Manim (3B1B-style) animations ‚Äî placeholder when no backend render is running.',
        metadata: {
          tier: 'manim',
          visualization: {
            tier: 'manim',
            title: 'Deep dive: Eigenvectors (placeholder)',
            narration: 'Manim video would appear here when the backend pipeline is used.'
          }
        }
      }
    };

    function pushTestViz(tierKey) {
      const msg = TEST_VIZ[tierKey];
      if (!msg) return;
      emptyState.style.display = 'none';
      const meta = msg.metadata || {};
      const actualTier = meta.tier || (meta.visualization && meta.visualization.tier);
      const vizPayload = meta.visualization || {};
      const cardId = 'viz-' + Date.now();
      const item = document.createElement('div');
      item.className = 'feed-item agent-response viz-feed-card';
      const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      item.innerHTML = '<div class="time">' + now + ' üé® <span class="agent-badge">Visualization</span> ' + actualTier + '</div>' +
        '<div class="viz-title">' + escapeHtml(vizPayload.title || 'Visualization') + '</div>' +
        '<div class="viz-canvas" id="' + cardId + '"></div>' +
        '<div class="viz-narration">' + escapeHtml(msg.content || vizPayload.narration || '') + '</div>';
      vizPayloadsByCardId[cardId] = { tier: actualTier, payload: vizPayload, title: vizPayload.title || 'Visualization', narration: msg.content || vizPayload.narration || '' };
      feed.appendChild(item);
      feed.scrollTop = feed.scrollHeight;
      const canvas = document.getElementById(cardId);
      if (canvas) setTimeout(function() { renderVizInCard(actualTier, vizPayload, canvas); }, 50);
    }

    function renderVizInCard(tier, payload, canvasEl) {
      if (!canvasEl) return;
      const narration = payload.narration || payload.content || '';
      // LaTeX: tool tier "latex" or overlay tier "static" with format "latex"
      if (tier === 'latex' || tier === 'static') {
        const fmt = payload.format || 'latex';
        const content = payload.content || '';
        if (fmt === 'latex' && window.katex) {
          canvasEl.innerHTML = '';
          var wrap = document.createElement('div');
          wrap.className = 'viz-latex';
          canvasEl.appendChild(wrap);
          try {
            katex.render(content, wrap, { throwOnError: false, displayMode: true });
          } catch (e) {
            wrap.innerHTML = '<pre>' + escapeHtml(content) + '</pre>';
          }
        } else if (fmt === 'mermaid' && window.mermaid) {
          canvasEl.innerHTML = '<div class="mermaid">' + escapeHtml(content) + '</div>';
          mermaid.run({ nodes: [canvasEl.querySelector('.mermaid')] }).catch(function() {});
        } else {
          canvasEl.innerHTML = '<pre>' + escapeHtml(content) + '</pre>';
        }
        return;
      }
      // D3: custom diagram from tool (code runs in sandboxed iframe)
      if (tier === 'd3' && payload.code) {
        var code = payload.code.replace(/<\/script/gi, '<\\/script');
        var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><script src="https://d3js.org/d3.v7.min.js"><\\/script><style>body{margin:0;background:rgba(0,0,0,0.1);}</style></head><body><div id="v"></div><script>' + code + '; if (typeof draw === "function") draw(document.getElementById("v"));<\\/script></body></html>';
        var iframe = document.createElement('iframe');
        iframe.setAttribute('sandbox', 'allow-scripts');
        iframe.style.cssText = 'width:100%;height:200px;border:0;border-radius:8px;';
        iframe.srcdoc = html;
        canvasEl.innerHTML = '';
        canvasEl.appendChild(iframe);
        return;
      }
      // Plotly: tool tier "plotly" or overlay "interactive" with plotly_figure
      if ((tier === 'plotly' || tier === 'interactive') && payload.plotly_figure && window.Plotly) {
        canvasEl.innerHTML = '';
        Plotly.newPlot(canvasEl, payload.plotly_figure.data || [], payload.plotly_figure.layout || {}, { responsive: true });
        return;
      }
      if (tier === 'manim') {
        var statusUrl = payload.status_url;
        var loadingMsg = payload.narration || 'Rendering 3B1B-style animation‚Ä¶';
        if (statusUrl) {
          canvasEl.innerHTML = '<p style="color:#9ca3af;text-align:center;max-width:280px;margin:0 auto;">üé¨ ' + escapeHtml(loadingMsg) + '</p><p style="color:rgba(255,255,255,0.4);font-size:11px;text-align:center;">Loading‚Ä¶</p>';
          var polls = 0, maxPolls = 80;
          var iv = setInterval(function() {
            polls++;
            fetch(BACKEND_ORIGIN + statusUrl).then(function(r) { return r.json(); }).then(function(data) {
              if (data.status === 'ready' && data.url) {
                clearInterval(iv);
                canvasEl.innerHTML = '<video src="' + BACKEND_ORIGIN + data.url + '" controls playsinline style="width:100%;border-radius:8px;"></video>';
              } else if (data.status === 'error') {
                clearInterval(iv);
                canvasEl.innerHTML = '<p style="color:#ef4444;text-align:center;font-size:12px;">' + escapeHtml(data.error || 'Render failed') + '</p>';
              }
            }).catch(function() {});
            if (polls >= maxPolls) { clearInterval(iv); canvasEl.innerHTML = '<p style="color:#9ca3af;text-align:center;">‚è± Timeout.</p>'; }
          }, 1500);
        } else {
          canvasEl.innerHTML = '<p style="color:#9ca3af;text-align:center;max-width:280px;margin:0 auto;">üé¨ ' + escapeHtml(loadingMsg) + '</p>';
        }
        return;
      }
      canvasEl.innerHTML = '<p style="color:#6b7280;">üìà ' + escapeHtml(payload.title || 'Visualization') + '</p>';
    }

    function openVizModal(cardId) {
      var stored = vizPayloadsByCardId[cardId];
      if (!stored) return;
      vizModalTitle.textContent = stored.title || 'Visualization';
      vizModalNarration.textContent = stored.narration || '';
      vizModalNarration.style.display = stored.narration ? 'block' : 'none';
      vizModalCanvas.innerHTML = '';
      renderVizInCard(stored.tier, stored.payload, vizModalCanvas);
      vizModal.classList.add('is-open');
      vizModal.setAttribute('aria-hidden', 'false');
    }
    function closeVizModal() {
      vizModal.classList.remove('is-open');
      vizModal.setAttribute('aria-hidden', 'true');
      if (window.Plotly && vizModalCanvas.querySelector('.plotly')) { try { Plotly.purge(vizModalCanvas); } catch (e) {} }
    }
    vizModalClose.addEventListener('click', closeVizModal);
    vizModal.addEventListener('click', function(e) { if (e.target === vizModal) closeVizModal(); });
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape' && vizModal.classList.contains('is-open')) closeVizModal(); });
    feed.addEventListener('click', function(e) {
      var card = e.target.closest('.viz-feed-card');
      if (!card) return;
      var canvas = card.querySelector('.viz-canvas');
      if (!canvas || !canvas.id) return;
      e.preventDefault();
      openVizModal(canvas.id);
    });
    document.querySelectorAll('.test-viz-btn').forEach(function(btn) {
      btn.addEventListener('click', function() { pushTestViz(btn.getAttribute('data-tier')); });
    });

    // ‚îÄ‚îÄ IPC listeners ‚îÄ‚îÄ
    window.api.onStartMic(() => startSpeechRecognition());
    window.api.onStopMic(() => stopSpeechRecognition());

    window.api.onGeminiResponse((data) => {
      emptyState.style.display = 'none';

      // Detect mode from response
      let mode = '';
      const text = data.text;
      if (text.includes('"CONCEPTUAL"') || text.includes("CONCEPTUAL")) mode = 'CONCEPTUAL';
      else if (text.includes('"APPLIED"') || text.includes("APPLIED")) mode = 'APPLIED';
      else if (text.includes('"CONSOLIDATION"') || text.includes("CONSOLIDATION")) mode = 'CONSOLIDATION';

      if (mode) updateAgentDisplay(mode);

      const item = document.createElement('div');
      item.className = `feed-item ${mode ? 'mode-' + mode : ''}`;

      const time = new Date(data.timestamp);
      const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      // Try to parse and display nicely
      let displayText = text;
      try {
        // Extract JSON from response (might have markdown fences)
        const jsonMatch = text.match(/\{[\s\S]*?\}/);
        if (jsonMatch) {
          const parsed = JSON.parse(jsonMatch[0]);
          displayText = `üìã ${parsed.activity || 'unknown'}\nüìö ${parsed.topic || 'unknown'}\nüß† ${parsed.mode || 'unknown'}`;
          if (parsed.stuck) displayText += '\n‚ö†Ô∏è Might be stuck';
          if (parsed.notes) displayText += `\nüí¨ ${parsed.notes}`;
        }
      } catch (e) {
        // Not JSON, show raw text
      }

      item.innerHTML = `
        <div class="time">${timeStr}</div>
        <div class="text">${escapeHtml(displayText)}</div>
      `;

      feed.appendChild(item);

      // Keep max 30 items
      const items = feed.querySelectorAll('.feed-item');
      while (items.length > 30 && feed.children.length > 31) {
        const removed = feed.children[1];
        const canvas = removed.querySelector('.viz-canvas');
        if (canvas && canvas.id) delete vizPayloadsByCardId[canvas.id];
        feed.removeChild(removed);
      }

      feed.scrollTop = feed.scrollHeight;
    });

    // ‚îÄ‚îÄ Agent responses from Python backend (via WebSocket ‚Üí main ‚Üí IPC) ‚îÄ‚îÄ
    window.api.onAgentResponse((msg) => {
      emptyState.style.display = 'none';

      const meta = msg.metadata || {};
      const tier = meta.tier;
      const vizPayload = meta.visualization || meta.scene || {};
      const isViz = msg.content_type === 'visualization' || (msg.tool_used === 'visualization' && (tier || vizPayload.tier));

      if (isViz && (tier || vizPayload.tier)) {
        const actualTier = tier || vizPayload.tier;
        const cardId = 'viz-' + Date.now();
        const item = document.createElement('div');
        item.className = 'feed-item agent-response viz-feed-card';
        const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        item.innerHTML = '<div class="time">' + now + ' üé® <span class="agent-badge">Visualization</span> ' + actualTier + '</div>' +
          '<div class="viz-title">' + escapeHtml(vizPayload.title || 'Visualization') + '</div>' +
          '<div class="viz-canvas" id="' + cardId + '"></div>' +
          '<div class="viz-narration">' + escapeHtml(msg.content || vizPayload.narration || '') + '</div>';
        vizPayloadsByCardId[cardId] = { tier: actualTier, payload: vizPayload, title: vizPayload.title || 'Visualization', narration: msg.content || vizPayload.narration || '' };
        feed.appendChild(item);
        feed.scrollTop = feed.scrollHeight;
        const canvas = document.getElementById(cardId);
        if (canvas) {
          if (window.katex || window.Plotly || window.mermaid) {
            renderVizInCard(actualTier, vizPayload, canvas);
          } else {
            setTimeout(function() { renderVizInCard(actualTier, vizPayload, canvas); }, 300);
          }
        }
        return;
      }

      const item = document.createElement('div');
      item.className = 'feed-item agent-response';

      const agentEmoji = {
        conceptual: 'üßê', applied: 'üîß', extension: 'üöÄ', orchestrator: 'üí°', visualizer: 'üé®'
      }[msg.agent_type] || 'ü§ñ';

      const agentLabel = {
        conceptual: 'Conceptual', applied: 'Applied',
        extension: 'Extension', orchestrator: 'Hint', visualizer: 'Visualization'
      }[msg.agent_type] || msg.agent_type;

      const toolEmoji = {
        question: '‚ùì', visualization: 'üé®', review: 'üîÑ', quiz: 'üìù'
      }[msg.tool_used] || '';

      const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      item.innerHTML = `
        <div class="time">${now} ${agentEmoji}<span class="agent-badge">${agentLabel}</span> ${toolEmoji}</div>
        <div class="text">${escapeHtml(msg.content || '')}</div>
      `;

      feed.appendChild(item);
      feed.scrollTop = feed.scrollHeight;
    });

    // ‚îÄ‚îÄ VLM observation updates (every ~3s) ‚Äî show as subtle status ‚îÄ‚îÄ
    let observationCount = 0;
    window.api.onAgentTriggered((data) => {
      observationCount++;
      emptyState.style.display = 'none';

      // Update agent display based on mode
      if (data.mode) updateAgentDisplay(data.mode);

      // Show as a subtle feed item (not a huge flash)
      const item = document.createElement('div');
      const modeClass = data.mode ? `mode-${data.mode}` : '';
      item.className = `feed-item ${modeClass}`;

      const now = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      item.innerHTML = `
        <div class="time">${now} üëÅÔ∏è observation #${observationCount}</div>
        <div class="text">üìö ${escapeHtml(data.topic || 'detecting...')}\nüìã ${escapeHtml(data.activity || 'analyzing screen')}</div>
      `;

      feed.appendChild(item);

      // Keep max 30 items
      const items = feed.querySelectorAll('.feed-item');
      while (items.length > 30 && feed.children.length > 31) {
        const removed = feed.children[1];
        const canvas = removed.querySelector('.viz-canvas');
        if (canvas && canvas.id) delete vizPayloadsByCardId[canvas.id];
        feed.removeChild(removed);
      }

      feed.scrollTop = feed.scrollHeight;
    });

    window.api.onStatusUpdate((data) => {
      statusDot.className = `status-dot ${data.status}`;
      statusText.textContent = data.message;
    });

    // ‚îÄ‚îÄ Toggle ‚îÄ‚îÄ
    toggleBtn.addEventListener('click', () => {
      isActive = !isActive;
      toggleBtn.classList.toggle('active', isActive);
      window.api.toggleSession();

      if (!isActive) {
        agentIcon.className = 'agent-icon idle';
        agentIcon.textContent = 'üëÅÔ∏è';
        agentName.textContent = 'Learning Agent';
        agentMode.textContent = 'Idle';
      }
    });

    // ‚îÄ‚îÄ Agent display ‚îÄ‚îÄ
    function updateAgentDisplay(mode) {
      const agents = {
        CONCEPTUAL: { icon: 'üßê', name: 'Sage', color: 'conceptual' },
        APPLIED: { icon: 'üîß', name: 'Builder', color: 'applied' },
        CONSOLIDATION: { icon: 'üîÑ', name: 'Echo', color: 'consolidation' },
      };
      const agent = agents[mode];
      if (!agent) return;

      agentIcon.textContent = agent.icon;
      agentIcon.className = `agent-icon ${agent.color}`;
      agentName.textContent = agent.name;
      agentMode.textContent = mode.charAt(0) + mode.slice(1).toLowerCase();
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
