<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      overflow: hidden;
    }

    .panel {
      position: absolute;
      top: 16px;
      right: 16px;
      bottom: 16px;
      width: 340px;
      background: rgba(20, 20, 30, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      -webkit-app-region: drag;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .agent-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .agent-icon.conceptual { background: rgba(139, 92, 246, 0.3); }
    .agent-icon.applied { background: rgba(59, 130, 246, 0.3); }
    .agent-icon.consolidation { background: rgba(16, 185, 129, 0.3); }
    .agent-icon.idle { background: rgba(255, 255, 255, 0.1); }

    .title {
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      font-weight: 600;
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.4);
      font-size: 11px;
    }

    /* ‚îÄ‚îÄ Toggle button ‚îÄ‚îÄ */
    .toggle-btn {
      -webkit-app-region: no-drag;
      width: 40px;
      height: 24px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      position: relative;
      transition: background 0.3s;
      background: rgba(255, 255, 255, 0.15);
    }

    .toggle-btn.active {
      background: rgba(16, 185, 129, 0.6);
    }

    .toggle-btn::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      transition: transform 0.3s;
    }

    .toggle-btn.active::after {
      transform: translateX(16px);
    }

    /* ‚îÄ‚îÄ Status bar ‚îÄ‚îÄ */
    .status-bar {
      padding: 8px 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      flex-shrink: 0;
      transition: background 0.3s;
    }

    .status-dot.ready { background: #fbbf24; }
    .status-dot.connecting { background: #f97316; animation: pulse 1s infinite; }
    .status-dot.active { background: #10b981; animation: pulse 2s infinite; }
    .status-dot.error { background: #ef4444; }
    .status-dot.disconnected { background: rgba(255, 255, 255, 0.3); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .status-text {
      color: rgba(255, 255, 255, 0.5);
      font-size: 11px;
      flex: 1;
    }

    .mic-indicator {
      font-size: 12px;
      opacity: 0.3;
      transition: opacity 0.3s;
    }

    .mic-indicator.listening {
      opacity: 1;
    }

    /* ‚îÄ‚îÄ Feed area ‚îÄ‚îÄ */
    .feed {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .feed::-webkit-scrollbar { width: 4px; }
    .feed::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 2px;
    }

    .feed-item {
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      animation: fadeIn 0.3s ease;
    }

    .feed-item .time {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.25);
      margin-bottom: 6px;
    }

    .feed-item .text {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .feed-item .speech-tag {
      font-size: 10px;
      color: rgba(139, 92, 246, 0.7);
      margin-bottom: 4px;
    }

    .feed-item.mode-CONCEPTUAL { border-left: 2px solid rgba(139, 92, 246, 0.5); }
    .feed-item.mode-APPLIED { border-left: 2px solid rgba(59, 130, 246, 0.5); }
    .feed-item.mode-CONSOLIDATION { border-left: 2px solid rgba(16, 185, 129, 0.5); }

    .feed-item.agent-response {
      border-left: 2px solid rgba(239, 68, 68, 0.7);
      background: rgba(239, 68, 68, 0.08);
    }
    .feed-item.agent-response .agent-badge {
      display: inline-block;
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 4px;
      background: rgba(239, 68, 68, 0.15);
      color: rgba(239, 68, 68, 0.9);
      margin-left: 6px;
      font-weight: 600;
    }

    /* ‚îÄ‚îÄ Agent trigger flash banner ‚îÄ‚îÄ */
    .agent-flash {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 12px 20px;
      background: linear-gradient(135deg, #ef4444, #f97316);
      color: white;
      font-weight: 700;
      font-size: 14px;
      text-align: center;
      z-index: 9999;
      animation: flashIn 0.3s ease, flashPulse 0.6s ease 0.3s 2;
      letter-spacing: 1px;
      text-transform: uppercase;
      box-shadow: 0 4px 20px rgba(239, 68, 68, 0.5);
    }
    .agent-flash .flash-detail {
      font-size: 11px;
      font-weight: 400;
      opacity: 0.9;
      margin-top: 2px;
      text-transform: none;
      letter-spacing: 0;
    }
    @keyframes flashIn {
      from { transform: translateY(-100%); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes flashPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    @keyframes flashOut {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(-100%); opacity: 0; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.25);
      font-size: 13px;
      text-align: center;
      padding: 40px;
      line-height: 1.6;
    }

    .empty-state .icon { font-size: 32px; margin-bottom: 12px; }
  </style>
</head>
<body>
  <div class="panel">
    <div class="header">
      <div class="header-left">
        <div class="agent-icon idle" id="agentIcon">üëÅÔ∏è</div>
        <div>
          <div class="title" id="agentName">Learning Agent</div>
          <div class="subtitle" id="agentMode">Idle</div>
        </div>
      </div>
      <button class="toggle-btn" id="toggleBtn" title="Start/stop session"></button>
    </div>

    <div class="status-bar">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-text" id="statusText">Initializing...</span>
      <span class="mic-indicator" id="micIndicator">üé§</span>
    </div>

    <div class="feed" id="feed">
      <div class="empty-state" id="emptyState">
        <div class="icon">üëÅÔ∏è</div>
        <div>Toggle the switch to start.<br>I'll watch your screen and listen<br>to understand what you're learning.</div>
      </div>
    </div>
  </div>

  <script>
    const feed = document.getElementById('feed');
    const emptyState = document.getElementById('emptyState');
    const toggleBtn = document.getElementById('toggleBtn');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const micIndicator = document.getElementById('micIndicator');
    const agentIcon = document.getElementById('agentIcon');
    const agentName = document.getElementById('agentName');
    const agentMode = document.getElementById('agentMode');

    let isActive = false;

    // ‚îÄ‚îÄ Speech Recognition (Web Speech API ‚Äî runs locally) ‚îÄ‚îÄ
    let recognition = null;

    function startSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.warn('[Speech] Web Speech API not available');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            const transcript = event.results[i][0].transcript.trim();
            if (transcript) {
              console.log('[Speech]', transcript);
              window.api.sendSpeechTranscript(transcript);
            }
          }
        }
      };

      recognition.onerror = (event) => {
        console.warn('[Speech] Error:', event.error);
        // Restart on non-fatal errors
        if (event.error === 'no-speech' || event.error === 'aborted') {
          if (isActive) {
            setTimeout(() => {
              try { recognition.start(); } catch (e) {}
            }, 500);
          }
        }
      };

      recognition.onend = () => {
        // Auto-restart if session is still active
        if (isActive) {
          try { recognition.start(); } catch (e) {}
        }
        micIndicator.classList.toggle('listening', isActive);
      };

      try {
        recognition.start();
        micIndicator.classList.add('listening');
        console.log('[Speech] Recognition started');
      } catch (e) {
        console.error('[Speech] Start error:', e);
      }
    }

    function stopSpeechRecognition() {
      if (recognition) {
        try { recognition.stop(); } catch (e) {}
        recognition = null;
      }
      micIndicator.classList.remove('listening');
    }

    // ‚îÄ‚îÄ IPC listeners ‚îÄ‚îÄ
    window.api.onStartMic(() => startSpeechRecognition());
    window.api.onStopMic(() => stopSpeechRecognition());

    window.api.onGeminiResponse((data) => {
      emptyState.style.display = 'none';

      // Detect mode from response
      let mode = '';
      const text = data.text;
      if (text.includes('"CONCEPTUAL"') || text.includes("CONCEPTUAL")) mode = 'CONCEPTUAL';
      else if (text.includes('"APPLIED"') || text.includes("APPLIED")) mode = 'APPLIED';
      else if (text.includes('"CONSOLIDATION"') || text.includes("CONSOLIDATION")) mode = 'CONSOLIDATION';

      if (mode) updateAgentDisplay(mode);

      const item = document.createElement('div');
      item.className = `feed-item ${mode ? 'mode-' + mode : ''}`;

      const time = new Date(data.timestamp);
      const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      // Try to parse and display nicely
      let displayText = text;
      try {
        // Extract JSON from response (might have markdown fences)
        const jsonMatch = text.match(/\{[\s\S]*?\}/);
        if (jsonMatch) {
          const parsed = JSON.parse(jsonMatch[0]);
          displayText = `üìã ${parsed.activity || 'unknown'}\nüìö ${parsed.topic || 'unknown'}\nüß† ${parsed.mode || 'unknown'}`;
          if (parsed.stuck) displayText += '\n‚ö†Ô∏è Might be stuck';
          if (parsed.notes) displayText += `\nüí¨ ${parsed.notes}`;
        }
      } catch (e) {
        // Not JSON, show raw text
      }

      item.innerHTML = `
        <div class="time">${timeStr}</div>
        <div class="text">${escapeHtml(displayText)}</div>
      `;

      feed.appendChild(item);

      // Keep max 30 items
      const items = feed.querySelectorAll('.feed-item');
      while (items.length > 30 && feed.children.length > 31) {
        feed.removeChild(feed.children[1]);
      }

      feed.scrollTop = feed.scrollHeight;
    });

    // ‚îÄ‚îÄ Agent responses from Python backend (via WebSocket ‚Üí main ‚Üí IPC) ‚îÄ‚îÄ
    window.api.onAgentResponse((msg) => {
      emptyState.style.display = 'none';

      const item = document.createElement('div');
      item.className = 'feed-item agent-response';

      const agentEmoji = {
        conceptual: 'üßê', applied: 'üîß', extension: 'üöÄ', orchestrator: 'üí°'
      }[msg.agent_type] || 'ü§ñ';

      const agentLabel = {
        conceptual: 'Conceptual', applied: 'Applied',
        extension: 'Extension', orchestrator: 'Hint'
      }[msg.agent_type] || msg.agent_type;

      const toolEmoji = {
        question: '‚ùì', visualization: 'üé®', review: 'üîÑ', quiz: 'üìù'
      }[msg.tool_used] || '';

      const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      item.innerHTML = `
        <div class="time">${now} ${agentEmoji}<span class="agent-badge">${agentLabel}</span> ${toolEmoji}</div>
        <div class="text">${escapeHtml(msg.content || '')}</div>
      `;

      feed.appendChild(item);
      feed.scrollTop = feed.scrollHeight;
    });

    // ‚îÄ‚îÄ VLM observation updates (every ~3s) ‚Äî show as subtle status ‚îÄ‚îÄ
    let observationCount = 0;
    window.api.onAgentTriggered((data) => {
      observationCount++;
      emptyState.style.display = 'none';

      // Update agent display based on mode
      if (data.mode) updateAgentDisplay(data.mode);

      // Show as a subtle feed item (not a huge flash)
      const item = document.createElement('div');
      const modeClass = data.mode ? `mode-${data.mode}` : '';
      item.className = `feed-item ${modeClass}`;

      const now = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      item.innerHTML = `
        <div class="time">${now} üëÅÔ∏è observation #${observationCount}</div>
        <div class="text">üìö ${escapeHtml(data.topic || 'detecting...')}\nüìã ${escapeHtml(data.activity || 'analyzing screen')}</div>
      `;

      feed.appendChild(item);

      // Keep max 30 items
      const items = feed.querySelectorAll('.feed-item');
      while (items.length > 30 && feed.children.length > 31) {
        feed.removeChild(feed.children[1]);
      }

      feed.scrollTop = feed.scrollHeight;
    });

    window.api.onStatusUpdate((data) => {
      statusDot.className = `status-dot ${data.status}`;
      statusText.textContent = data.message;
    });

    // ‚îÄ‚îÄ Toggle ‚îÄ‚îÄ
    toggleBtn.addEventListener('click', () => {
      isActive = !isActive;
      toggleBtn.classList.toggle('active', isActive);
      window.api.toggleSession();

      if (!isActive) {
        agentIcon.className = 'agent-icon idle';
        agentIcon.textContent = 'üëÅÔ∏è';
        agentName.textContent = 'Learning Agent';
        agentMode.textContent = 'Idle';
      }
    });

    // ‚îÄ‚îÄ Agent display ‚îÄ‚îÄ
    function updateAgentDisplay(mode) {
      const agents = {
        CONCEPTUAL: { icon: 'üßê', name: 'Sage', color: 'conceptual' },
        APPLIED: { icon: 'üîß', name: 'Builder', color: 'applied' },
        CONSOLIDATION: { icon: 'üîÑ', name: 'Echo', color: 'consolidation' },
      };
      const agent = agents[mode];
      if (!agent) return;

      agentIcon.textContent = agent.icon;
      agentIcon.className = `agent-icon ${agent.color}`;
      agentName.textContent = agent.name;
      agentMode.textContent = mode.charAt(0) + mode.slice(1).toLowerCase();
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
