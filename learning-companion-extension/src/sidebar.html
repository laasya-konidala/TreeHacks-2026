<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      background: transparent;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      overflow: hidden;
    }

    .panel {
      width: 100%;
      height: 100%;
      background: rgba(20, 20, 30, 0.95);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .agent-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .agent-icon.conceptual { background: rgba(139, 92, 246, 0.3); }
    .agent-icon.applied { background: rgba(59, 130, 246, 0.3); }
    .agent-icon.consolidation { background: rgba(16, 185, 129, 0.3); }
    .agent-icon.idle { background: rgba(255, 255, 255, 0.1); }

    .title {
      color: rgba(255, 255, 255, 0.9);
      font-size: 14px;
      font-weight: 600;
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.4);
      font-size: 11px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ‚îÄ‚îÄ Toggle button ‚îÄ‚îÄ */
    .toggle-btn {
      width: 40px;
      height: 24px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      position: relative;
      transition: background 0.3s;
      background: rgba(255, 255, 255, 0.15);
    }

    .toggle-btn.active {
      background: rgba(16, 185, 129, 0.6);
    }

    .toggle-btn::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: white;
      transition: transform 0.3s;
    }

    .toggle-btn.active::after {
      transform: translateX(16px);
    }

    /* ‚îÄ‚îÄ Close button ‚îÄ‚îÄ */
    .close-btn {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.8);
    }

    /* ‚îÄ‚îÄ Status bar ‚îÄ‚îÄ */
    .status-bar {
      padding: 8px 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      flex-shrink: 0;
      transition: background 0.3s;
    }

    .status-dot.ready { background: #fbbf24; }
    .status-dot.connecting { background: #f97316; animation: pulse 1s infinite; }
    .status-dot.active { background: #10b981; animation: pulse 2s infinite; }
    .status-dot.error { background: #ef4444; }
    .status-dot.disconnected { background: rgba(255, 255, 255, 0.3); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .status-text {
      color: rgba(255, 255, 255, 0.5);
      font-size: 11px;
      flex: 1;
    }

    .mic-indicator {
      font-size: 12px;
      opacity: 0.3;
      transition: opacity 0.3s;
    }

    .mic-indicator.listening {
      opacity: 1;
    }

    /* ‚îÄ‚îÄ Feed area ‚îÄ‚îÄ */
    .feed {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .feed::-webkit-scrollbar { width: 4px; }
    .feed::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 2px;
    }

    .feed-item {
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      animation: fadeIn 0.3s ease;
    }

    .feed-item .time {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.25);
      margin-bottom: 6px;
    }

    .feed-item .text {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .feed-item .speech-tag {
      font-size: 10px;
      color: rgba(139, 92, 246, 0.7);
      margin-bottom: 4px;
    }

    .feed-item.mode-CONCEPTUAL { border-left: 2px solid rgba(139, 92, 246, 0.5); }
    .feed-item.mode-APPLIED { border-left: 2px solid rgba(59, 130, 246, 0.5); }
    .feed-item.mode-CONSOLIDATION { border-left: 2px solid rgba(16, 185, 129, 0.5); }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.25);
      font-size: 13px;
      text-align: center;
      padding: 40px;
      line-height: 1.6;
    }

    .empty-state .icon { font-size: 32px; margin-bottom: 12px; }

    /* ‚îÄ‚îÄ Avatar dropdown ‚îÄ‚îÄ */
    .avatar-row {
      padding: 10px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .avatar-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 12px;
      font-weight: 500;
    }
    .avatar-select {
      flex: 1;
      max-width: 140px;
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      background: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.9);
      font-size: 13px;
      cursor: pointer;
    }
    .avatar-select:focus {
      outline: none;
      border-color: rgba(16, 185, 129, 0.5);
    }
  </style>
</head>
<body>
  <div class="panel">
    <div class="avatar-row">
      <label for="avatarSelect" class="avatar-label">Avatar</label>
      <select id="avatarSelect" class="avatar-select" title="Choose avatar">
        <option value="plato">Plato</option>
        <option value="einstein">Einstein</option>
      </select>
    </div>
    <div class="header">
      <div class="header-left">
        <div class="agent-icon idle" id="agentIcon">&#x1F441;&#xFE0F;</div>
        <div>
          <div class="title" id="agentName">Learning Agent</div>
          <div class="subtitle" id="agentMode">Idle</div>
        </div>
      </div>
      <div class="header-right">
        <button class="toggle-btn" id="toggleBtn" title="Start/stop session"></button>
        <button class="close-btn" id="btnClose" title="Close sidebar">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-text" id="statusText">Ready ‚Äî click toggle to start.</span>
      <span class="mic-indicator" id="micIndicator">&#x1F3A4;</span>
    </div>

    <div class="feed" id="feed">
      <div class="empty-state" id="emptyState">
        <div class="icon">&#x1F441;&#xFE0F;</div>
        <div>Toggle the switch to start.<br>I'll watch your screen and listen<br>to understand what you're learning.</div>
      </div>
    </div>
  </div>

  <script>
    const feed = document.getElementById('feed');
    const emptyState = document.getElementById('emptyState');
    const toggleBtn = document.getElementById('toggleBtn');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const micIndicator = document.getElementById('micIndicator');
    const agentIcon = document.getElementById('agentIcon');
    const agentName = document.getElementById('agentName');
    const agentMode = document.getElementById('agentMode');

    let isActive = false;

    // ‚îÄ‚îÄ Helper: send message to parent (content script) ‚îÄ‚îÄ
    function sendToParent(type, data) {
      window.parent.postMessage({ type, ...data }, '*');
    }

    // ‚îÄ‚îÄ Speech Recognition (Web Speech API) ‚îÄ‚îÄ
    let recognition = null;

    function startSpeechRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.warn('[Speech] Web Speech API not available');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            const transcript = event.results[i][0].transcript.trim();
            if (transcript) {
              console.log('[Speech]', transcript);
              sendToParent('speech-transcript', { transcript });
            }
          }
        }
      };

      recognition.onerror = (event) => {
        console.warn('[Speech] Error:', event.error);
        if (event.error === 'no-speech' || event.error === 'aborted') {
          if (isActive) {
            setTimeout(() => {
              try { recognition.start(); } catch (e) {}
            }, 500);
          }
        }
      };

      recognition.onend = () => {
        if (isActive) {
          try { recognition.start(); } catch (e) {}
        }
        micIndicator.classList.toggle('listening', isActive);
      };

      try {
        recognition.start();
        micIndicator.classList.add('listening');
        console.log('[Speech] Recognition started');
      } catch (e) {
        console.error('[Speech] Start error:', e);
      }
    }

    function stopSpeechRecognition() {
      if (recognition) {
        try { recognition.stop(); } catch (e) {}
        recognition = null;
      }
      micIndicator.classList.remove('listening');
    }

    // ‚îÄ‚îÄ Listen for messages from content script (forwarded from background) ‚îÄ‚îÄ
    window.addEventListener('message', (event) => {
      const msg = event.data;
      if (!msg || !msg.type) return;

      if (msg.type === 'gemini-response') {
        handleGeminiResponse(msg);
      } else if (msg.type === 'status-update') {
        statusDot.className = `status-dot ${msg.status}`;
        statusText.textContent = msg.message;
      } else if (msg.type === 'start-mic') {
        startSpeechRecognition();
      } else if (msg.type === 'stop-mic') {
        stopSpeechRecognition();
      }
    });

    function handleGeminiResponse(data) {
      emptyState.style.display = 'none';

      let mode = '';
      const text = data.text;
      if (text.includes('"CONCEPTUAL"') || text.includes('CONCEPTUAL')) mode = 'CONCEPTUAL';
      else if (text.includes('"APPLIED"') || text.includes('APPLIED')) mode = 'APPLIED';
      else if (text.includes('"CONSOLIDATION"') || text.includes('CONSOLIDATION')) mode = 'CONSOLIDATION';

      if (mode) updateAgentDisplay(mode);

      const item = document.createElement('div');
      item.className = `feed-item ${mode ? 'mode-' + mode : ''}`;

      const time = new Date(data.timestamp);
      const timeStr = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      let displayText = text;
      try {
        const jsonMatch = text.match(/\{[\s\S]*?\}/);
        if (jsonMatch) {
          const parsed = JSON.parse(jsonMatch[0]);
          displayText = `üìã ${parsed.activity || 'unknown'}\nüìö ${parsed.topic || 'unknown'}\nüß† ${parsed.mode || 'unknown'}`;
          if (parsed.stuck) displayText += '\n‚ö†Ô∏è Might be stuck';
          if (parsed.notes) displayText += `\nüí¨ ${parsed.notes}`;
        }
      } catch (e) {
        // Not JSON, show raw text
      }

      item.innerHTML = `
        <div class="time">${timeStr}</div>
        <div class="text">${escapeHtml(displayText)}</div>
      `;

      feed.appendChild(item);

      // Keep max 30 items
      const items = feed.querySelectorAll('.feed-item');
      while (items.length > 30 && feed.children.length > 31) {
        feed.removeChild(feed.children[1]);
      }

      feed.scrollTop = feed.scrollHeight;
    }

    // ‚îÄ‚îÄ Toggle ‚îÄ‚îÄ
    toggleBtn.addEventListener('click', () => {
      isActive = !isActive;
      toggleBtn.classList.toggle('active', isActive);
      sendToParent('toggle-session', {});

      if (!isActive) {
        agentIcon.className = 'agent-icon idle';
        agentIcon.textContent = 'üëÅÔ∏è';
        agentName.textContent = 'Learning Agent';
        agentMode.textContent = 'Idle';
      }
    });

    // ‚îÄ‚îÄ Close button ‚îÄ‚îÄ
    document.getElementById('btnClose').addEventListener('click', () => {
      sendToParent('lc-close-sidebar', {});
    });

    document.getElementById('avatarSelect').addEventListener('change', (e) => {
      sendToParent('lc-set-avatar', { avatar: e.target.value });
    });

    // ‚îÄ‚îÄ Agent display ‚îÄ‚îÄ
    function updateAgentDisplay(mode) {
      const agents = {
        CONCEPTUAL: { icon: 'üßê', name: 'Sage', color: 'conceptual' },
        APPLIED: { icon: 'üîß', name: 'Builder', color: 'applied' },
        CONSOLIDATION: { icon: 'üîÑ', name: 'Echo', color: 'consolidation' },
      };
      const agent = agents[mode];
      if (!agent) return;

      agentIcon.textContent = agent.icon;
      agentIcon.className = `agent-icon ${agent.color}`;
      agentName.textContent = agent.name;
      agentMode.textContent = mode.charAt(0) + mode.slice(1).toLowerCase();
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
